# Scaffold-ETH 2ë¡œ ê°„ë‹¨í•œ ì£¼ì‚¬ìœ„ ê²Œì„ ë§Œë“¤ê¸°

## ğŸš© Step 0. ë¬´ì‘ìœ„ì„±?

ì»´í“¨í„°ëŠ” ì‚¬ëŒê³¼ ë‹¬ë¦¬ ë¬´ì˜ì‹ì ì¸ ì„ íƒì„ í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ì§„ì •í•œ ë‚œìˆ˜ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ë‹¤. ëŒ€ì‹ , ê¸°ì¡´ì˜ ì…ë ¥ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ â€˜ê²°ì •ë¡ ì â€™ì¸ ë°©ë²•ìœ¼ë¡œ ë‚œìˆ˜ë¥¼ ìƒì„±í•œë‹¤. ì´ëŠ” ë¸”ë¡ì²´ì¸ì—ì„œë„ ë§ˆì°¬ê°€ì§€ì¸ë°, ë¸”ë¡ì²´ì¸ì—ì„œëŠ” ëª¨ë“  ë…¸ë“œê°€ ê°™ì€ ê²°ê³¼ê°’ì„ ì¶œë ¥í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ë¡œì»¬ ë°ì´í„°ë¥¼ ì‚¬ìš©í•œ ë‚œìˆ˜ ìƒì„±ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤. ë•Œë¬¸ì— ë¸”ë¡ì²´ì¸ì—ì„œ ë‚œìˆ˜ ìƒì„±ì€ ë”ìš± ì–´ë ¤ìš´ ë¬¸ì œê°€ ëœë‹¤.

ë¸”ë¡ì²´ì¸ì—ì„œ ë‚œìˆ˜ë¥¼ ìƒì„±í•˜ëŠ” ë°©ì‹ì€ ì—¬ëŸ¬ ê°€ì§€ê°€ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë¸”ë¡ì˜ ìƒíƒœê°’ì„ ì¡°í•©í•˜ì—¬ ë‚œìˆ˜ ìƒì„±ì˜ ì…ë ¥ê°’ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ë‚˜, â€˜Commit and Revealâ€™ ë°©ì‹ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ ìˆë‹¤. ê·¸ ì™¸ì—ë„ VDF(Verifiable Delay Function), Signidice ë“± ë‹¤ì–‘í•œ ë°©ë²•ì´ ì¡´ì¬í•œë‹¤.

ê·¸ë ‡ë‹¤ë©´ ì™œ ë¸”ë¡ì²´ì¸ì—ì„œ ë‚œìˆ˜ê°€ í•„ìš”í• ê¹Œ? ì—¬ëŸ¬ ê°€ì§€ ì´ìœ ê°€ ìˆì§€ë§Œ, ê·¸ì¤‘ í•˜ë‚˜ëŠ” ë°¸ë¦¬ë°ì´í„°ë¥¼ ì„ ì¶œí•  ë•Œ ë‚œìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë‹¤. ì´ ê³¼ì •ì€ ëª¨ë“  ë…¸ë“œê°€ ë°›ì•„ë“¤ì¼ ìˆ˜ ìˆì–´ì•¼ í•˜ê³ , ëˆ„êµ¬ë„ ì¡°ì‘í•  ìˆ˜ ì—†ì–´ì•¼ í•œë‹¤. ë”°ë¼ì„œ ë¸”ë¡ì²´ì¸ì—ì„œëŠ” íƒˆì¤‘ì•™í™”ë¥¼ ìœ ì§€í•˜ë©´ì„œ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë‚œìˆ˜ ìƒì„±ì´ í•„ìš”í•˜ë‹¤. ì´ì²˜ëŸ¼ ë¬´ì‘ìœ„ì„±ì€ ë¸”ë¡ì²´ì¸ì—ì„œ ë§¤ìš° ì¤‘ìš”í•œ ë¬¸ì œì´ë‹¤.

> ğŸ”¥ ì´ë²ˆ ë¯¸ì…˜ì—ì„œëŠ” ë¸”ë¡ í•´ì‹œë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚œìˆ˜ë¥¼ ìƒì„±í•˜ê³ , ì´ë¥¼ ì´ìš©í•œ ì£¼ì‚¬ìœ„ ê²Œì„ ì›¹ì•± í”„ë¡ íŠ¸ì—”ë“œë¥¼ ì œì‘í•œë‹¤.

---

## ğŸš© Step 1. í™˜ê²½

í”„ë¡œì íŠ¸ í´ë¡ í•´ê°€ê¸°

```sh
git clone -b dice-game --single-branch https://github.com/Ludium-Official/solidity-dapp-mission.git dice-game
cd dice-game
yarn install
```
---

### Op1) ë¡œì»¬ í™˜ê²½ì—ì„œ ì‹¤í–‰

```sh
# ë¡œì»¬ ë¸”ë¡ì²´ì¸ ì´ˆê¸°í™”
yarn chain

# ìŠ¤ë§ˆíŠ¸ ê³„ì•½ ë°°í¬
yarn deploy

# í”„ë¡ íŠ¸ì—”ë“œ ì‹¤í–‰
yarn start
```

ğŸ“± http://localhost:3000 ìœ¼ë¡œ ì ‘ì†í•´ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì—´ê¸°

---

### Op2) í…ŒìŠ¤íŠ¸ë„· í™˜ê²½ì—ì„œ ì‹¤í–‰

**ğŸªª ë°°í¬ì (Deployer) ì„¤ì •**

***ë°©ë²• 1. ë°°í¬ì ì£¼ì†Œë¥¼ ìƒì„±í•˜ì—¬ ì‚¬ìš©***

ì£¼ì†Œê°€ ìƒì„±ë˜ë©´ ë‹ˆëª¨ë‹‰ì€ ë¡œì»¬ì— ì €ì¥ë˜ê³ , í”„ë¼ì´ë¹— í‚¤ë¥¼ ë”°ë¡œ ì…ë ¥í•˜ì§€ ì•Šê³  ê³„ì•½ì„ ë°°í¬í•  ìˆ˜ ìˆë‹¤.

```sh
# ë°°í¬ì ì£¼ì†Œ ìƒì„±
yarn generate

# ë¡œì»¬ ê³„ì • ì”ì•¡ í™•ì¸
yarn account
```
ìœ„ì—ì„œ ìƒì„±ëœ ì£¼ì†Œë¡œ sepoliaETHë¥¼ ë³´ë‚´ê±°ë‚˜ ê³µê°œ faucetì—ì„œ ë°›ëŠ”ë‹¤.

***ë°©ë²• 2. ì‹¤ì œ ì†Œìœ í•œ ì£¼ì†Œë¥¼ ì‚¬ìš©***

`packages/hardhat/.env` ë° `packages/nextjs/.env.local`ì„ ìˆ˜ì •í•œë‹¤.

```bash
# .env
ALCHEMY_API_KEY=
DEPLOYER_PRIVATE_KEY=
```
ë³¸ì¸ ê³„ì •ì˜ [Alchemy](https://dashboard.alchemy.com/apps) Apps API keyì™€ ì†Œìœ í•˜ê³  ìˆëŠ” ì§€ê°‘ì˜ í”„ë¼ì´ë¹— í‚¤ë¥¼ ê¸°ì…í•œë‹¤.

> Metamask ì§€ê°‘ì˜ ê²½ìš°, ê³„ì • ì„¸ë¶€ ì •ë³´ë¡œ ë“¤ì–´ê°€ë©´ í”„ë¼ì´ë¹— í‚¤ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.

<br/>

**ğŸª ë°°í¬í•˜ê¸°**

***ë°©ë²• 1. defaultNetwork ì„¤ì •***
`packages/hardhat/hardhat.config.ts`ì—ì„œ defaultNetworkë¥¼ `sepolia`ë¡œ ë³€ê²½í•œë‹¤.

```sh
yarn deploy
```

***ë°©ë²• 2. ëª…ë ¹ì—ì„œ ë„¤íŠ¸ì›Œí¬ ì§€ì •***
```sh
yarn deploy --network sepolia
```

<br/>

**ğŸ›ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬í•˜ê¸°**

`packages/nextjs/scaffold.config.ts`ë¥¼ ì•„ë˜ì²˜ëŸ¼ ë³€ê²½í•œë‹¤.

```typescript
const scaffoldConfig = {
  targetNetworks: [chains.sepolia],

  // ...

  onlyLocalBurnerWallet: false,
} as const satisfies ScaffoldConfig;
```

NestJS ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬í•œë‹¤. [Vercel](https://vercel.com/) ì—ì„œ ë¡œê·¸ì¸ í›„ dashboardë¡œ ì´ë™í•´ `Add New -> Project` ë¥¼ í´ë¦­í•œ í›„ GitHub repositoryë¥¼ ì„í¬íŠ¸í•´ì˜¨ë‹¤.

```shell
yarn vercel
```

ğŸ“± Vercelì´ ì œê³µí•˜ëŠ” url ë¡œ ì ‘ì†í•´ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì—´ê¸°

---

## ğŸš© Step 2. ì£¼ì‚¬ìœ„ ë¡¤

`Dice Game` ì—ì„œ `Roll the dice!` ë²„íŠ¼ì„ í´ë¦­í•´ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦°ë‹¤.

ì‚¬ìš©ìê°€ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦´ ë•Œ ì°¸ê°€ë¹„ë¡œ 0.002 ETH ë¥¼ ì§€ë¶ˆí•˜ê³ , `0,1,2,3,4,5`ê°€ ë‚˜ì˜¤ë©´ í˜„ì¬ ìƒê¸ˆ ê¸ˆì•¡ì„ íšë“ í•œë‹¤.

ì‚¬ìš©ìê°€ ë³´ë‚¸ 0.002 ETH ì¤‘ 40%ëŠ” í˜„ì¬ ìƒê¸ˆì— ì¶”ê°€ë˜ê³ , ë‚˜ë¨¸ì§€ 60%ëŠ” ë¯¸ë˜ ìƒê¸ˆì„ ë§ˆë ¨í•˜ê¸° ìœ„í•´ `DiceGame.sol` ì»¨íŠ¸ë™íŠ¸ì— ë‚¨ì•„ìˆë‹¤.

<img src='./images/roll_the_dice.png' width='600px'/>

> âš ï¸ 0.002 ETH ë³´ë‹¤ ì ìœ¼ë©´ `rollTheDice()` í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤.

---

## ğŸš© Step 3. ê²Œì„ ì¡°ì‘

ìœ„ì˜ `rollTheDice()` í•¨ìˆ˜ì—ì„œ ì£¼ì‚¬ìœ„ ê²°ê³¼ ê°’ì„ ë„ì¶œí•  ë•Œ ì´ì „ ë¸”ë¡ì˜ í•´ì‹œ ê°’ê³¼ ì»¨íŠ¸ë™íŠ¸ ì£¼ì†Œ, nonce ê°’ì„ ì‚¬ìš©í•œë‹¤.

```solidity
// DiceGame.sol

function rollTheDice() public payable {

  // ...

  // ì´ì „ ë¸”ë¡ì˜ í•´ì‹œ ê°’
  bytes32 prevHash = blockhash(block.number - 1);
  // í•´ì‹œ ê°’ì„ ì‚¬ìš©í•˜ì—¬ ë‚œìˆ˜ë¥¼ ìƒì„±
  bytes32 hash = keccak256(abi.encodePacked(prevHash, address(this), nonce));
  // ì£¼ì‚¬ìœ„ ê²°ê³¼ ê°’ì„ 0ì—ì„œ 15 ì‚¬ì´ë¡œ ì„¤ì •
  uint256 roll = uint256(hash) % 16;

  // ...

}
```

ë”°ë¼ì„œ ì´ ì„¸ ê°œì˜ ê°’ì„ ë¯¸ë¦¬ ì•Œê³  ìˆë‹¤ë©´, ê²°ê³¼ ê°’ì„ ë¯¸ë¦¬ ì˜ˆì¸¡í•  ìˆ˜ ìˆë‹¤.

ì¶”ê°€ì ì¸ ì»¨íŠ¸ë™íŠ¸ `RiggedRoll.sol` ì— ê²°ê³¼ ê°’ì„ ë¨¼ì € ì˜ˆì¸¡í•œ ë’¤ ì„±ê³µí–ˆì„ ë•Œë§Œ `DiceGame.sol`ì˜ `rollTheDice()`ë¥¼ ì‹¤í–‰í•˜ê²Œ í•˜ëŠ” í•¨ìˆ˜ë¥¼ ì‘ì„±í•œë‹¤.

```solidity
function riggedRoll() public payable {
    require(address(this).balance >= .002 ether, "Not enough ether");

    // DiceGame.solì˜ rollTheDice í•¨ìˆ˜ì™€ ë™ì¼í•˜ê²Œ ì£¼ì‚¬ìœ„ ê²°ê³¼ ê°’ ë„ì¶œ
    bytes32 prevHash = blockhash(block.number - 1);
    bytes32 hash = keccak256(abi.encodePacked(prevHash, address(diceGame), diceGame.nonce()));
    uint256 roll = uint256(hash) % 16;
    console.log("\t", "   Rigged Roll", block.number, roll);

    // 0,1,2,3,4,5ê°€ ë‚˜ì˜¤ë©´ DiceGame.solì˜ rollTheDice ì‹¤í–‰
    require(roll <= 5, "Failed");
    diceGame.rollTheDice{value: msg.value}();
}
```

â—ï¸ RigedRoll contractë¥¼ `deploy`í•˜ê¸° ì „ `packages/hardhat/deploy/01_deploy_riggedRoll.ts` ì—ì„œ ì†Œìœ ìë¥¼ ë‚˜ì˜ ì§€ê°‘ ì£¼ì†Œë¡œ ë³€ê²½í•œë‹¤.

```typescript
// ë‚˜ì¤‘ì— ë‚¨ì•„ìˆëŠ” ì”ê³ ë¥¼ ì¸ì¶œ ë°›ì„ ì§€ê°‘ ì£¼ì†Œë¥¼ ì…ë ¥
try {
  await riggedRoll.transferOwnership("ë‚´ ì§€ê°‘ ì£¼ì†Œ");
} catch (err) {
  console.log(err);
}
```

ì´ì œ ë‹¤ì‹œ `Dice Game` íƒ­ì—ì„œ `Rigged Roll` ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦°ë‹¤.

ì‹¤íŒ¨í•˜ë©´ requireë¬¸ì— ì˜í•´ íŠ¸ëœì­ì…˜ ìì²´ê°€ revert ë˜ì–´ ì°¸ê°€ë¹„ê°€ ì§€ë¶ˆë˜ì§€ ì•ŠëŠ”ë‹¤.

```solidity
require(roll <= 5, "Failed");
```

<img src='./images/rigged_roll_failed.png' width='600px' />

ì„±ê³µí•˜ë©´ ìƒê¸ˆì´ `RiggedRoll.sol`ìœ¼ë¡œ ë³´ë‚´ì§„ë‹¤.

<img src='./images/rigged_roll_succeed.png' width='600px' />

---

## ğŸš© Step 4. ì”ì•¡ ì¸ì¶œ

ì§€ê¸ˆê¹Œì§€ ì£¼ì‚¬ìœ„ ê²Œì„ìœ¼ë¡œ ìŒ“ì¸ ìƒê¸ˆ(ETH)ì„ ì¸ì¶œí•´ë³´ì.

`Debug Contracts` íƒ­ì˜ `RiggedRoll`ì—ì„œ `withdraw()` í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•œë‹¤.

<img src='./images/withdraw.png' width='300px' />

ê²°ê³¼ì ìœ¼ë¡œ ì‚¬ìš©ìëŠ” ì•„ë¬´ëŸ° ë¦¬ìŠ¤í¬ ì—†ì´ ì£¼ì‚¬ìœ„ ê²Œì„ì„ ì¦ê¸¸ ìˆ˜ ìˆë‹¤.