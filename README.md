# Scaffold-ETH 2ë¡œ ë©€í‹° ì‹œê·¸ ë§Œë“¤ê¸°

## ğŸš© Step 0. ë©€í‹° ì‹œê·¸ (Multi Signature)ë€?

ìš°ë¦¬ê°€ ì‚¬ìš©í•˜ëŠ” ì—¬ëŸ¬ ë¸”ë¡ì²´ì¸ ë„¤íŠ¸ì›Œí¬ì˜ ê³„ì •ë“¤ì€ ì¼ë°˜ì ìœ¼ë¡œ 1ê°œì˜ ì„œëª…ì„ ìš”êµ¬í•˜ì§€ë§Œ, ë©€í‹° ì‹œê·¸ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •ëœ ê³„ì •ì€ 2ê°œ ì´ìƒì˜ ì„œëª…ì„ í•„ìš”ë¡œ í•œë‹¤.

2ê°œ ì´ìƒì˜ ê³„ì •ì´ ì„œëª…ì„ í•˜ë„ë¡ ì„¤ì •ë˜ëŠ” ê²½ìš°, í•œ ê³„ì •ì˜ í”„ë¼ì´ë¹—í‚¤ê°€ í•´í‚¹ë˜ê±°ë‚˜ ìœ ì¶œëœë‹¤ê³  í•˜ë”ë¼ë„ ìì‚°ì˜ íƒˆì·¨ëŠ” ë¶ˆê°€ëŠ¥í•˜ë‹¤. ì„œëª…ì„ í•˜ë„ë¡ ì„¤ì •ëœ ê°€ì¤‘ì¹˜ë§Œí¼ì˜ ê³„ì •ë“¤ì˜ í”„ë¼ì´ë¹— í‚¤ë¥¼ ëª¨ë‘ ê°€ì§€ê³  ìˆì–´ì•¼ ìì‚°ì„ ë¹¼ë‚¼ ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤.

> Ex) 7ê°œ ê³„ì • ì¤‘ 4ê°œ ì´ìƒì´ ì„œëª…í•´ì•¼ í•˜ëŠ” ê²½ìš°ì—ëŠ” 4ê°œì˜ í”„ë¼ì´ë¹— í‚¤ê°€ í•„ìš”

ë˜í•œ, ë©€í‹° ì‹œê·¸ì—ì„œëŠ” í•©ì˜ë¥¼ í†µí•œ ìš´ì˜ì´ ê°€ëŠ¥í•˜ë‹¤. ë§Œì•½ íŠ¹ì • í”„ë¡œì íŠ¸ì˜ ê³µë™ ì°½ì—…ìê°€ ì—¬ëŸ¬ ëª…ì¸ ê²½ìš° ê³¼ë°˜ìˆ˜ ì´ìƒì´ ì°¬ì„±í•˜ëŠ” ê²½ìš°ì—ë§Œ ì¼ì„ ì§„í–‰í•  ìˆ˜ ìˆë„ë¡ ë©€í‹° ì‹œê·¸ë¥¼ í†µí•´ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

> Ex) ì–´ë–¤ ê³¼ì—…ì— í€ë“œë¥¼ ì§‘í–‰í•˜ê¸°ë¡œ í•œ ê²½ìš°, 5ëª… ì¤‘ 3ëª… ì´ìƒì´ ì„œëª…ì„ í†µí•´ ì°¬ì„±í‘œë¥¼ ë˜ì§€ë©´ ìì‚°ì„ ë³´ëƒ„

ë‹¤ì¤‘ ì„œëª… ì§€ê°‘ì€ ì´ê°™ì´ ì ì¬ì ì¸ ì´ì ì´ ìˆìŒì—ë„ ë¶ˆêµ¬í•˜ê³  ë³µì¡ì„±ê³¼ ì ì¬ì ì¸ ìœ„í—˜ì„ ì•ˆê³  ìˆìœ¼ë©°, ì‚¬ìš©ìëŠ” ì´ ì†”ë£¨ì…˜ì„ ì±„íƒí•˜ê¸° ì „ì— ì´ëŸ¬í•œ ì ì„ ì´í•´í•˜ê³  ìˆì–´ì•¼ í•œë‹¤.

> ğŸ”¥ ì´ë²ˆ ë¯¸ì…˜ì—ì„œëŠ” ë©€í‹° ì‹œê·¸ ì›”ë ›ìœ¼ë¡œ ì •í•´ì§„ ì„œëª… ê°œìˆ˜ë¥¼ ì¶©ì¡±í–ˆì„ ë•Œ ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ì›¹ì•± í”„ë¡ íŠ¸ì—”ë“œë¥¼ ì œì‘í•œë‹¤.

---

## ğŸš© Step 1. í™˜ê²½

í”„ë¡œì íŠ¸ í´ë¡ í•´ê°€ê¸°

```sh
git clone -b multi-sig --single-branch https://github.com/Ludium-Official/solidity-dapp-mission.git multi-sig
cd multi-sig
yarn install
```
---

### Op1) ë¡œì»¬ í™˜ê²½ì—ì„œ ì‹¤í–‰

```sh
# ë¡œì»¬ ë¸”ë¡ì²´ì¸ ì´ˆê¸°í™”
yarn chain

# ìŠ¤ë§ˆíŠ¸ ê³„ì•½ ë°°í¬
yarn deploy

# í”„ë¡ íŠ¸ì—”ë“œ ì‹¤í–‰
yarn start
```

ğŸ“± http://localhost:3000 ìœ¼ë¡œ ì ‘ì†í•´ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì—´ê¸°

---

### Op2) í…ŒìŠ¤íŠ¸ë„· í™˜ê²½ì—ì„œ ì‹¤í–‰

**ğŸªª ë°°í¬ì (Deployer) ì„¤ì •**

***ë°©ë²• 1. ë°°í¬ì ì£¼ì†Œë¥¼ ìƒì„±í•˜ì—¬ ì‚¬ìš©***

ì£¼ì†Œê°€ ìƒì„±ë˜ë©´ ë‹ˆëª¨ë‹‰ì€ ë¡œì»¬ì— ì €ì¥ë˜ê³ , í”„ë¼ì´ë¹— í‚¤ë¥¼ ë”°ë¡œ ì…ë ¥í•˜ì§€ ì•Šê³  ê³„ì•½ì„ ë°°í¬í•  ìˆ˜ ìˆë‹¤.

```sh
# ë°°í¬ì ì£¼ì†Œ ìƒì„±
yarn generate

# ë¡œì»¬ ê³„ì • ì”ì•¡ í™•ì¸
yarn account
```
ìœ„ì—ì„œ ìƒì„±ëœ ì£¼ì†Œë¡œ sepoliaETHë¥¼ ë³´ë‚´ê±°ë‚˜ ê³µê°œ faucetì—ì„œ ë°›ëŠ”ë‹¤.

***ë°©ë²• 2. ì‹¤ì œ ì†Œìœ í•œ ì£¼ì†Œë¥¼ ì‚¬ìš©***

`packages/hardhat/.env` ë° `packages/nextjs/.env.local`ì„ ìˆ˜ì •í•œë‹¤.

```bash
# .env
ALCHEMY_API_KEY=
DEPLOYER_PRIVATE_KEY=
```
ë³¸ì¸ ê³„ì •ì˜ [Alchemy](https://dashboard.alchemy.com/apps) Apps API keyì™€ ì†Œìœ í•˜ê³  ìˆëŠ” ì§€ê°‘ì˜ í”„ë¼ì´ë¹— í‚¤ë¥¼ ê¸°ì…í•œë‹¤.

> Metamask ì§€ê°‘ì˜ ê²½ìš°, ê³„ì • ì„¸ë¶€ ì •ë³´ë¡œ ë“¤ì–´ê°€ë©´ í”„ë¼ì´ë¹— í‚¤ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.

<br/>

**ğŸª ë°°í¬í•˜ê¸°**

***ë°©ë²• 1. defaultNetwork ì„¤ì •***
`packages/hardhat/hardhat.config.ts`ì—ì„œ defaultNetworkë¥¼ `sepolia`ë¡œ ë³€ê²½í•œë‹¤.

```sh
yarn deploy
```

***ë°©ë²• 2. ëª…ë ¹ì—ì„œ ë„¤íŠ¸ì›Œí¬ ì§€ì •***
```sh
yarn deploy --network sepolia
```

<br/>

**ğŸ›ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬í•˜ê¸°**

`packages/nextjs/scaffold.config.ts`ë¥¼ ì•„ë˜ì²˜ëŸ¼ ë³€ê²½í•œë‹¤.

```typescript
const scaffoldConfig = {
  targetNetworks: [chains.sepolia],

  // ...

  onlyLocalBurnerWallet: false,
} as const satisfies ScaffoldConfig;
```

NestJS ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬í•œë‹¤. [Vercel](https://vercel.com/) ì—ì„œ ë¡œê·¸ì¸ í›„ dashboardë¡œ ì´ë™í•´ `Add New -> Project` ë¥¼ í´ë¦­í•œ í›„ GitHub repositoryë¥¼ ì„í¬íŠ¸í•´ì˜¨ë‹¤.

```shell
yarn vercel
```

ğŸ“± Vercelì´ ì œê³µí•˜ëŠ” url ë¡œ ì ‘ì†í•´ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì—´ê¸°

---

## ğŸš© Step 2. ë°±ì—”ë“œ ì„œë²„ ì‹¤í–‰

ì¶”ê°€ì ìœ¼ë¡œ ì´ë²ˆ ë¯¸ì…˜ì—ì„œëŠ” ë°±ì—”ë“œ ì„œë²„ë¥¼ í•¨ê»˜ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì—, í„°ë¯¸ë„ì„ ì¶”ê°€ë¡œ ì—´ì–´ì„œ ì•„ë˜ ëª…ë ¹ì„ ì‹¤í–‰í•œë‹¤.

```bash
node packages/backend/index.js
```

ë©€í‹° ì‹œê·¸ì—ì„œ ë°±ì—”ë“œ ì„œë²„ë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ 

1. ì„œëª…ëœ íŠ¸ëœì­ì…˜ì„ ì˜¤í”„ì²´ì¸ìœ¼ë¡œ ê¸°ë¡í•˜ê³  ì €ì¥í•˜ì—¬ í•„ìš”í•  ë•Œ ë°ì´í„°ë¥¼ ì‰½ê²Œ ê²€ìƒ‰í•  ìˆ˜ ìˆê²Œ í•œë‹¤.

2. ë™ì¼í•œ íŠ¸ëœì­ì…˜ì´ ì—¬ëŸ¬ ë²ˆ ì œì¶œë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ íŠ¸ëœì­ì…˜ í•´ì‹œë¥¼ í‚¤ë¡œ ì‚¬ìš©í•˜ì—¬ ì €ì¥í•˜ê³  ê´€ë¦¬í•œë‹¤.

---

## ğŸš© Step 3. ì§€ê°‘ ì£¼ì†Œ ì„¤ì •

ì´ë²ˆ ë¯¸ì…˜ì—ì„œëŠ” ì„œëª…ì— í•„ìš”í•œ ì„œëª…ì ê°ì²´ë¥¼ ethers.js ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì œê³µí•˜ëŠ” providerë¥¼ í†µí•´ ë°›ì•„ì˜¤ê¸° ë•Œë¬¸ì—, ì„œëª…ì„ ìš”ì²­í•  ë•Œ providerê°€ ì¸ì‹í•  ìˆ˜ ìˆëŠ” ì§€ê°‘ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

```typescript
// í˜„ì¬ ì§€ì • ë„¤íŠ¸ì›Œí¬ì™€ ìƒí˜¸ì‘ìš©í•˜ëŠ” provider ê°ì²´ ìƒì„±
const provider = new ethers.JsonRpcProvider(targetNetwork.rpcUrls.default.http[0]);

// ì£¼ì–´ì§„ ì£¼ì†Œì™€ ì—°ê²°ëœ ì„œëª…ì ê°ì²´ ê°€ì ¸ì˜¤ê¸°
const signer = await provider.getSigner(account.address);
// JSON-RPC ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¸ëœì­ì…˜ í•´ì‹œ(txHash)ì˜ ì„œëª…ì„ ìƒì„±
const signature = await signer.provider.send("personal_sign", [txHash, account.address])
```

ë¡œì»¬ í™˜ê²½ì—ì„œ ì§„í–‰í•˜ëŠ” ê²½ìš°, ë¡œì»¬ ë¸”ë¡ì²´ì¸ì—ì„œ ì œê³µí•˜ëŠ” ê°€ê³„ì •ì„ ì§€ê°‘ì— ì—°ê²°í•˜ì—¬ ì‚¬ìš©í•˜ì.

<img src='./images/accounts.png' width='400px' />

---

## ğŸš© Step 4. ì„œëª…ì ì¶”ê°€

`packages/hardhat/deploy/00_deploy_your_contract.ts`ì—ì„œ ë°°í¬ì— í•„ìš”í•œ ë§¤ê°œë³€ìˆ˜ë¡œ ì²´ì¸ ì•„ì´ë””, ì´ˆê¸° ì§€ê°‘ ì„œëª…ì ì£¼ì†Œ, ì´ˆê¸° í•„ìš”í•œ ì„œëª… ê°œìˆ˜ë¥¼ ì„¤ì •í•œë‹¤.

```typescript
await deploy("MetaMultiSigWallet", {
from: deployer,
// ë§¤ê°œë³€ìˆ˜: ì²´ì¸ ì•„ì´ë””, ì´ˆê¸° ì§€ê°‘ ì„œëª…ì ì£¼ì†Œ, ì´ˆê¸° í•„ìš”í•œ ì„œëª… ê°œìˆ˜
args: [31337, [deployer], 1],
log: true,
autoMine: true,
});
```

ë°°í¬ê°€ ì™„ë£Œë˜ë©´ `Home` íƒ­ì—ì„œ ìƒˆë¡œìš´ ë©€í‹° ì‹œê·¸ ì§€ê°‘, `Owners` íƒ­ì—ì„œ ì´ˆê¸° ì„¤ì •í•œ ì„œëª…ìì™€ ì„œëª… ê°œìˆ˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

<img src='./images/multi_sig_wallet.png' width='300px' />

<img src='./images/owners.png' width='300px' />

ì´ì œ `Owners` íƒ­ì—ì„œ ìƒˆë¡œìš´ ì„œëª…ìë¥¼ ì¶”ê°€í•´ë³´ì.

ì¶”ê°€í•˜ê³  ì‹¶ì€ ì£¼ì†Œì™€ ì„œëª…ì˜ ìˆ˜ë¥¼ ì ê³  `Create Tx` ë²„íŠ¼ì„ í´ë¦­í•œë‹¤.

<img src='./images/addSigner_1.png' width='300px' />

ìŠ¤ë§ˆíŠ¸ ê³„ì•½ì˜ íŠ¹ì • í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê¸° ìœ„í•œ calldataê°€ ìƒì„±ë˜ê³ , `Create` íƒ­ìœ¼ë¡œ ë„˜ì–´ê°„ë‹¤.

<img src='./images/addSigner_2.png' width='300px' />

ì„¸ë¶€ ë‚´ìš©ì„ í™•ì¸í•œ í›„, `Create` ë²„íŠ¼ì„ í´ë¦­í•œë‹¤.

ì´ ë‹¨ê³„ì—ì„œ, ì´ë²ˆ íŠ¸ëœì­ì…˜ì— ëŒ€í•œ í•´ì‹œì™€ ì„œëª…ì„ ìƒì„±í•˜ê³ ,

```solidity
// hardhat/MetaMultiSigWallet.sol

function getTransactionHash(uint256 _nonce, address to, uint256 value, bytes memory data) public view returns (bytes32) {
	return keccak256(abi.encodePacked(address(this), chainId, _nonce, to, value, data));
}
```

```typescript
// nextjs/app/create/page.tsx

const signature = await signer.provider.send("personal_sign", [txHash, account.address])
```

ì´ ë‘ ê°œì˜ ê°’ìœ¼ë¡œ ì„œëª…ì„ ë³µêµ¬í•œë‹¤.

```solidity
// hardhat/MetaMultiSigWallet.sol

function recover(bytes32 _hash, bytes memory _signature) public pure returns (address) {
	return _hash.toEthSignedMessageHash().recover(_signature);
}
```

ë³µêµ¬í•œ ì£¼ì†Œê°€ ì§€ê°‘ì˜ ì†Œìœ ìê°€ ë§ëŠ”ì§€ í™•ì¸í•œ í›„, ë§ë‹¤ë©´ íŠ¸ëœì­ì…˜ì˜ ë‚´ìš©ì´ ë°±ì—”ë“œ ì„œë²„ì— ì €ì¥ë˜ê³  `Pool` íƒ­ìœ¼ë¡œ ë„˜ì–´ê°„ë‹¤.

<img src='./images/addSigner_3.png' width='500px' />

í˜„ì¬ ëŒ€ê¸° ì¤‘ì¸ íŠ¸ëœì­ì…˜ ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

í•´ë‹¹ íŠ¸ëœì­ì…˜ì„ ìƒì„±í•œ ê³„ì •ì˜ ì„œëª…ì€ ì´ë¯¸ ì¶”ê°€ëœ ìƒíƒœì´ê¸° ë•Œë¬¸ì—, `Exec` ë²„íŠ¼ì„ ëˆŒëŸ¬ ìµœì¢…ì ìœ¼ë¡œ íŠ¸ëœì­ì…˜ì„ ì‹¤í–‰í•œë‹¤.

```solidity
// hardhat/MetaMultiSigWallet.sol

function executeTransaction(address payable to, uint256 value, bytes memory data, bytes[] memory signatures)
	public
{
	// ì†Œìœ ìë§Œ ì‹¤í–‰ ê°€ëŠ¥í•¨
	require(isOwner[msg.sender], "executeTransaction: only owners can execute");

	bytes32 _hash =  getTransactionHash(nonce, to, value, data); // íŠ¸ëœì­ì…˜ í•´ì‹œ
	nonce++; // nonce ì¦ê°€
	uint256 validSignatures; // ìœ íš¨ ì„œëª… ìˆ˜
	address duplicateGuard; // ì¤‘ë³µ ê²€ì‚¬

	for (uint i = 0; i < signatures.length; i++) {
		address recovered = recover(_hash, signatures[i]); // ì„œëª…ì—ì„œ ì£¼ì†Œ ë³µêµ¬
		require(recovered != duplicateGuard, "executeTransaction: duplicate or unordered signatures");
		duplicateGuard = recovered;
		if(isOwner[recovered]){
			validSignatures++; // ìœ íš¨ ì„œëª… ì¦ê°€
		}
	}

	// ìœ íš¨ ì„œëª…ì´ ì¶©ë¶„í•œì§€ í™•ì¸
	require(validSignatures>=signaturesRequired, "executeTransaction: not enough valid signatures");

	// íŠ¸ëœì­ì…˜ ì‹¤í–‰
	(bool success, ) = to.call{value: value}(data);
	console.log('result: ', success);
	require(success, "executeTransaction: tx failed");

	emit ExecuteTransaction(msg.sender, to, value, data, nonce-1, _hash);
}
```

ìµœì¢…ì ìœ¼ë¡œ Ownersì— ìƒˆë¡œìš´ ì„œëª…ìê°€ ì¶”ê°€ë˜ê³ , ì„œëª… ê°œìˆ˜ê°€ ë³€ê²½ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

<img src='./images/addSigner_4.png' width='300px' />

---

## ğŸš© Step 5. ì„œëª…ì ì œê±° & ì„œëª… ê°œìˆ˜ ì¶©ì¡±

ì´ë²ˆì—ëŠ” ì¶”ê°€í–ˆë˜ ì„œëª…ìë¥¼ ë‹¤ì‹œ ì œê±°í•´ë³´ì.

<img src='./images/removeSigner_1.png' width='300px' />

ì„œëª…ìë¥¼ ì œê±°í•˜ê³  ë‚˜ë©´ ìµœì´ˆ ì„œëª…ì í•œ ëª…ë§Œ ë‚¨ê¸° ë•Œë¬¸ì— í•„ìš” ì„œëª… ê°œìˆ˜ë„ 1ê°œë¡œ ë‹¤ì‹œ ë³€ê²½í•œë‹¤.

<img src='./images/removeSigner_2.png' width='500px' />

íŠ¸ëœì­ì…˜ ìƒì„±ìì˜ ì„œëª… ì™¸ì—, í•œ ê°œì˜ ì„œëª…ì´ ë” í•„ìš”í•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

<img src='./images/removeSigner_3.png' width='300px' />

ë§Œì•½ ì„œëª… ê°œìˆ˜ë¥¼ ì±„ìš°ì§€ ì•Šê³  `Exec` ë²„íŠ¼ì„ í´ë¦­í•˜ë©´, ì„œëª… ê°œìˆ˜ê°€ ì¶©ë¶„í•˜ì§€ ì•Šë‹¤ëŠ” ë¬¸êµ¬ê°€ ëœ¬ë‹¤.

íŠ¸ëœì­ì…˜ ìƒì„±ì ì™¸ì— ë‹¤ë¥¸ ì§€ê°‘ ì†Œìœ ì ê³„ì •ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ `Sign` ë²„íŠ¼ì„ í´ë¦­í•œë‹¤.

<img src='./images/removeSigner_4.png' width='500px' />

ì„œëª…ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìœ¼ë©´ `Exec` ë²„íŠ¼ì„ í´ë¦­í•´ íŠ¸ëœì­ì…˜ì„ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.

---

**[Multi Sig Wallet Sequence]**

<img src='./images/sequence.png' width='700px' />